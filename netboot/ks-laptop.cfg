# Celastrina Laptop — network install kickstart
# Deploys butterfly-ublue-laptop via PXE/netboot.xyz
#
# Boot chain:
#   PXE → netboot.xyz → custom menu (collects LUKS passphrase + tang URL)
#   → Fedora 43 Everything net install kernel/initrd
#   → this kickstart reads config from kernel args
#   → ostreecontainer pulls the bootc image
#   → clevis tang enrollment (if tang URL was provided)
#
# Kernel args set by the iPXE menu:
#   celastrina.luks_pass="<passphrase>"  — LUKS encryption passphrase (quoted, supports spaces)
#   celastrina.tang_url=<url>            — Clevis Tang server for automatic LUKS unlock

text
network --bootproto=dhcp --device=link --activate

# Disk layout generated by %pre (reads LUKS passphrase from kernel cmdline)
%include /tmp/disk-config.ks

# Deploy the bootc container image (replaces %packages)
ostreecontainer --url ghcr.io/butterflysky/butterfly-ublue-laptop:latest --no-signature-verification

firewall --disabled
services --enabled=sshd
rootpw --iscrypted locked
reboot

# --- Pre-install: read config from kernel cmdline, generate disk layout ---
%pre
#!/bin/bash

# Extract LUKS passphrase (quoted value from kernel cmdline)
PASS=$(sed -n 's/.*celastrina\.luks_pass="\([^"]*\)".*/\1/p' /proc/cmdline)
# Fallback: unquoted value (no spaces)
[ -z "$PASS" ] && PASS=$(sed -n 's/.*celastrina\.luks_pass=\([^ ]*\).*/\1/p' /proc/cmdline)

if [ -z "$PASS" ]; then
    echo "ERROR: No LUKS passphrase provided via kernel cmdline."
    echo "Set it in the netboot.xyz Celastrina menu before booting."
    sleep 10
    exit 1
fi

# Save passphrase for tang enrollment in %post
echo -n "$PASS" > /tmp/luks-passphrase
chmod 600 /tmp/luks-passphrase

# Write partition config
cat > /tmp/disk-config.ks <<EOF
clearpart --all --initlabel --disklabel=gpt
reqpart --add-boot
part /boot --fstype ext4 --size 1024
part pv.01 --size 1 --grow --encrypted --luks-version luks2 --passphrase ${PASS}
volgroup vg0 pv.01
logvol / --vgname=vg0 --fstype btrfs --name=root --size 1 --grow
EOF

# Extract tang URL from kernel cmdline
TANG_URL=$(sed -n 's/.*celastrina\.tang_url=\([^ ]*\).*/\1/p' /proc/cmdline)
echo -n "$TANG_URL" > /tmp/tang-url

[ -n "$TANG_URL" ] && echo "Tang server configured: $TANG_URL"
%end

# --- Post-install: attempt clevis tang enrollment ---
%post --nochroot --log=/tmp/tang-enrollment.log
#!/bin/bash
TANG_URL=$(cat /tmp/tang-url 2>/dev/null)
if [ -z "$TANG_URL" ]; then
    echo "No Tang server configured — skipping clevis enrollment"
    exit 0
fi

echo "Attempting clevis tang enrollment for $TANG_URL ..."

LUKS_DEV=$(blkid -t TYPE=crypto_LUKS -o device | head -1)
if [ -z "$LUKS_DEV" ]; then
    echo "ERROR: Could not find LUKS device — enroll manually after boot:"
    echo "  sudo clevis luks bind -d <device> tang '{\"url\":\"$TANG_URL\"}'"
    exit 0
fi

echo "Found LUKS device: $LUKS_DEV"

mount --bind /dev /mnt/sysimage/dev
mount --bind /proc /mnt/sysimage/proc
mount --bind /sys /mnt/sysimage/sys
mount --bind /run /mnt/sysimage/run

# Enroll tang using clevis from the installed image (-f = trust on first use)
PASS=$(cat /tmp/luks-passphrase 2>/dev/null)
if echo -n "$PASS" | chroot /mnt/sysimage clevis luks bind -f -d "$LUKS_DEV" tang "{\"url\":\"$TANG_URL\"}" 2>&1; then
    echo "Clevis Tang enrollment successful — automatic LUKS unlock via $TANG_URL"
else
    echo "WARNING: Clevis Tang enrollment failed."
    echo "Enroll manually after first boot:"
    echo "  sudo clevis luks bind -d $LUKS_DEV tang '{\"url\":\"$TANG_URL\"}'"
fi

umount /mnt/sysimage/run 2>/dev/null
umount /mnt/sysimage/sys 2>/dev/null
umount /mnt/sysimage/proc 2>/dev/null
umount /mnt/sysimage/dev 2>/dev/null
rm -f /tmp/luks-passphrase
%end
